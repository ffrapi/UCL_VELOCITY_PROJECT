ssh -l fpitsill -J fpitsill@knuckles.cs.ucl.ac.uk pchuckle
#enter password 4/10/21

cd /SAN/ugi/LepGenomics #access shared folder
mkdir C3_Aricia_agestis_FP #created new folder 

#13/10/21

#PRENAME
mkdir scripts
nano prename.pl
/share/apps/perl-5.30.0/bin/perl5.30.0 ../../prename.pl --help
prename.pl
ls prename.pl
nano prename.pl


#COPIED ALL DATA FROM C3_Aricia_agestis TO C3_Aricia_agestis_FP

    #Museum1 (190312)
cp *gz /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_museum
cp *log /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_museum
cp *html /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_museum
            #Example file: AAg-19-1900-02_190312_L005_R1.fastq.gz 

    #Museum2 (191121)
cp *zip /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_museum2 
cp *log /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_museum2
cp *html /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_museum2
            #Example file: AAg-19-1900-04_191121_L003_R1.fastq.gz 

    #Modern1 (L002)
cp *gz /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_modern

    #Modern2_exp (L001)
cp *gz /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_modern_exp


#CONCATENATE MUSEUM SAMPLES

mkdir 00_raw_reads_museum_FINAL/
ls 00_raw_reads_museum/*R1*gz | awk -F "/" '{print $NF}' | awk -F "_" '{print $1}' > museum1.names
ls 00_raw_reads_museum/ALLSAMPLES/*R1*gz | awk -F "/" '{print $NF}' | awk -F "_" '{print $1}' > museumconcat.names
diff museum1.names museumconcat.names | grep 'AAg' | sed 's/^>\ //'> museum1.tomove
wc -l museum1.tomove > count
echo "number of samples to move:" $count
for i in $(cat museum1.tomove); do cp 00_raw_reads_museum/ALLSAMPLES/$i*gz 00_raw_reads_museum_FINAL; done



#14/10/21

#CUTADAPT ON 5 MUSEUM1 SAMPLES

mkdir 00_raw_reads_museum_sample 
cp 01a_museum1_cutadapt_filtering_trimming.sh /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_museum_sample
nano 01a_museum1_cutadapt_filtering_trimming.sh #Changed species name to C3_Aricia_agestis_FP, and Infile/outfile and species number by changing -t from 48 to 5
./01a_museum1_cutadapt_filtering_trimming.sh  #outputs command used to submit job to the cluster
qsub /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01a_filtered_reads_museum_sample/parallel_cutadapt.20211014-125514.smsjob.sh #job submitted to cluster
qstat #to check the status of the job

#CUTADAPT ON 2 MODERN SAMPLES

mkdir 00_raw_reads_modern_exp_sample
cp AAg-19-2016-01_L002_R1.fastq.gz /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_modern_exp_sample
cp AAg-19-2016-02_L002_R1.fastq.gz /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_modern_exp_sample
cp 01a_modern_cutadapt_filtering_trimming.sh /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_modern_exp_sample
nano 01a_modern_cutadapt_filtering_trimming.sh #Changed species name to C3_Aricia_agestis_FP and species number by changing -t from 48 to 5
./01a_modern_cutadapt_filtering_trimming.sh
qsub /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_modern_sample/01a_modern_cutadapt_reads/parallel_cutadapt.20211014-210144.smsjob.sh
qstat

#15/10/21

#CUTADAPT on 2 MODERN SAMPLES RE-ATTEMPT

cp AAg-19-2016-01_L001_R*.fastq.gz /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_modern_sample
mkdir cutadapt_modern_test_output
 nano cutadapt_script_test.sh
 
                ##EDITED FILE
                               SHAREDFOLDER=/SAN/ugi/LepGenomics
                            SCRIPTS=VelocityPipeline/tools
                            SPECIES=C3_Aricia_agestis_FP
                            INFILE=00_raw_reads_modern_sample
                            OUTFILE=00_raw_reads_modern_sample/cutadapt_modern_test_output

                            $SHAREDFOLDER/$SCRIPTS/01a_parallel_cutadapt_UCL.sh \
                            -i $SHAREDFOLDER/$SPECIES/$INFILE \
                            -o $SHAREDFOLDER/$SPECIES/$OUTFILE -t 2 -m 8 -ph 33 \
                            -fwad1 AGATCGGAAGAGCACACGTCTGAACTCCAGTC -rvad1 AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT \
                            -minl 20 -phredq 20;
                            
./cutadapt_script_test.sh 
qsub /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_modern_sample/cutadapt_modern_test_output/parallel_cutadapt.20211015-193411.smsjob.sh
parallel_cutadapt.20211015-193411 - job name/number


#CHECKING JOB STATUS

    #1 Go to output directory specified in the .sh script
    #2 Go to the log file
    #3 The title of the log file gives the name of the job, in the format "jobname".o"jobnumber"."arraynumber", eg parallel_cutadapt.20211015-193411
    #4 move to the home directory using cd and check what log files have written and at what time using ls -ltr *.o*
  

#17/10/21

#Cutadapt sample museum 
cp AAg-19-2016-01_L001_R*.fastq.gz /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_modern_sample
cp AAg-19-1900-03_190312_L005_R*.fastq.gz /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_museum_sample
mkdir 01a_museum_cutadapt_reads
nano 01a_museum1_cutadapt_filtering_trimming.sh 

            #Output: 
                        #!/bin/bash
                        ##################################
                        # Alexandra Jansen van Rensburg
                        # alexjvr@gmail.com
                        # Last modified 06/07/2021 11:22
                        ##################################

                        # Creates submission script to use cutadapt to remove adapters from demultiplexed Illumina libraries.
                        # Poly-A and -T filters have been removed as we decided that these would be dropped due to mapping quality by bwa mem.
                        # Additional filters included in Lymantria monacha dataset
                        # -fwad2 CTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT -fwad3 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
                        # -rvad2 CTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT -rvad3 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

                        SHAREDFOLDER=/SAN/ugi/LepGenomics
                        SCRIPTS=VelocityPipeline/tools
                        SPECIES=C3_Aricia_agestis_FP
                        INFILE=00_raw_reads_museum_sample
                        OUTFILE=00_raw_reads_museum_sample/01a_museum_cutadapt_reads

                        $SHAREDFOLDER/$SCRIPTS/01a_parallel_cutadapt_UCL.sh \
                        -i $SHAREDFOLDER/$SPECIES/$INFILE \
                        -o $SHAREDFOLDER/$SPECIES/$OUTFILE -t 4 -m 8 -ph 33 \
                        -fwad1 AGATCGGAAGAGCACACGTCTGAACTCCAGTC -rvad1 AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT \
                        -minl 20 -phredq 20;


./01a_museum1_cutadapt_filtering_trimming.sh
qsub /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_museum_sample/01a_museum_cutadapt_reads/parallel_cutadapt.20211017-122826.smsjob.sh
qstat #Started at 12.30 Eqw status after 5-10 minutes

    #Rerun museum cutadapt: 
qsub /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_museum_sample/01a_museum_cutadapt_reads/parallel_cutadapt.20211017-130001.smsjob.sh
qstat #Started running at 13:00

#testing bbtools on cutadapt modern samples 

/share/apps/genomics/bbmap-38.59/bbmap.sh

ls 01a_modern_cutadapt_reads/*R1*fastq.gz >> R1.modern.names.torepair
ls 01a_modern_cutadapt_reads/*R2*fastq.gz >> R2.modern.names.torepair
sed -i 's:01a_modern_cutadapt_reads/::g' *torepair

mkdir 01b_modPERepaired 

nano 01b_bbtools_repair_museum_ARRAY.sh

            #OUTPUT: 
                        #!/bin/bash
                        #$ -S /bin/bash
                        #$ -N E3.BBRepair  ##job name
                        #$ -l tmem=16G #RAM
                        #$ -l h_vmem=16G #enforced limit on shell memory usage
                        #$ -l h_rt=1:00:00 ##wall time.
                        #$ -j y  #concatenates error and output files (with prefix job1)
                        #$ -t 1-1

                        #run job in working directory
                        cd $SGE_O_WORKDIR
                        pwd

                        #Load modules
                        export PATH=/share/apps/java/bin:$PATH
                        export LD_LIBRARY_PATH=/share/apps/java/lib:$LD_LIBRARY_PATH

                        #Define variables
                        BBREPAIR=/share/apps/genomics/bbmap-38.59/repair.sh
                        SHAREDPATH=/SAN/ugi/LepGenomics
                        SPECIESDIR=$SHAREDPATH/E3_Aphantopus_hyperantus
                        PATH1=01a_modern_cutadapt_reads
                        PATH2=01c_modPERepaired

                        # create input files here by:
                        #ls $SPECIESDIR/$PATH1/*R1* | awk -F "/" '{print $NF}' > R1.modern.names.torepair
                        #ls $SPECIESDIR/$PATH1/*R2* | awk -F "/" '{print $NF}' > R2.modern.names.torepair

                        NAME1=$(sed "${SGE_TASK_ID}q;d" R1.modern.names.torepair)
                        NAME2=$(sed "${SGE_TASK_ID}q;d" R2.modern.names.torepair)


                        ##Run BBRepair
                        PREFIX=`echo ${NAME2} |awk -F "_" '{print $1}'`
                        echo "$BBREPAIR in=$SPECIESDIR/$PATH1/${NAME1} in2=$SPECIESDIR/$PATH1/${NAME2} out=$SPECIESDIR/$PATH2/${PREFIX}.R1.repaired.fastq.gz o$
                        time $BBREPAIR in=$SPECIESDIR/$PATH1/${NAME1} in2=$SPECIESDIR/$PATH1/${NAME2} out=$SPECIESDIR/$PATH2/${PREFIX}.R1.repaired.fastq.gz ou$

./01c_bbtools_repair_museum_ARRAY.sh
#Permission denied


#18/10/21

#bbtools for museum 

ls 01a_museum_cutadapt_reads/*R1*fastq.gz >> R1.museum.names.torepair
ls 01a_museum_cutadapt_reads/*R2*fastq.gz >> R2.museum.names.torepair

sed -i 's:01a_museum_cutadapt_reads/::g' *torepair

nano 01c_bbtools_repair_museum_ARRAY.sh: 
                                #!/bin/bash
                                #$ -S /bin/bash
                                #$ -N C3.BBRepair  ##job name
                                #$ -l tmem=32G #RAM
                                #$ -l h_vmem=32G #enforced limit on shell memory usage
                                #$ -l h_rt=1:00:00 ##wall time.
                                #$ -j y  #concatenates error and output files (with prefix job1)
                                #$ -t 1-2

                                #run job in working directory
                                cd $SGE_O_WORKDIR
                                pwd

                                #Load modules
                                export PATH=/share/apps/java/bin:$PATH
                                export LD_LIBRARY_PATH=/share/apps/java/lib:$LD_LIBRARY_PATH

                                #Define variables
                                BBREPAIR=/share/apps/genomics/bbmap-38.59/repair.sh
                                SPECIESDIR=/SAN/ugi/LepGenomics/C3_Aricia_agestis_FP
                                PATH1=00_raw_reads_museum_sample/01a_museum_cutadapt_reads
                                PATH2=00_raw_reads_museum_sample/01b_musPERepaired

                                # create input files here by:
                                #ls $SPECIESDIR/$PATH1/*R1* | awk -F "/" '{print $NF}' > R1.museum.names.torepair
                                #ls $SPECIESDIR/$PATH1/*R2* | awk -F "/" '{print $NF}' >  R2.museum.names.torepair


                                NAME1=$(sed "${SGE_TASK_ID}q;d" R1.museum.names.torepair)
                                NAME2=$(sed "${SGE_TASK_ID}q;d" R2.museum.names.torepair)


                                ##Run BBRepair
                                PREFIX=`echo ${NAME2} |awk -F "_" '{print $1}'`
                                echo "$BBREPAIR in=$SPECIESDIR/$PATH1/${NAME1} out=$SPECIESDIR/$PATH2/${PREFIX}.R1.repaired.fastq.gz overwrite=f tossbrokenreads " >> repa$
                                time $BBREPAIR in=$SPECIESDIR/$PATH1/${NAME1} out=$SPECIESDIR/$PATH2/${PREFIX}.R1.repaired.fastq.gz overwrite=f tossbrokenreads
 
 #For the script of bbtools, the number of individuals was changed from 1-48 to 1-4 (as this is a sample run), the SPECIESDIR was changed to C3_Aricia_agestis_FP, and PATH1 and PATH2 were changed according to where the 01a_museum_Cutadapt_reads and the new directory 01b_musPERepaired are located.
 #Job submitted at 18.56pm, finished 5-10 minutes later for 2 sequences.
 
 #BBtools merge
 
 mkdir 01c_musAll_merged
 
 ls 01b_musPERepaired/*R1*gz >> R1.museum.names.repaired
 ls 01b_musPERepaired/*R2*gz >> R2.museum.names.repaired
 sed -i 's:01b_musPERepaired/::g' *repaired
 
 nano 01c_bbtools_merge_museum_ARRAY.sh: 
 
                #!/bin/bash
                                #$ -S /bin/bash
                                #$ -N E3.BBmerge  ##job name
                                #$ -l tmem=16G #RAM
                                #$ -l h_vmem=16G #enforced limit on shell memory usage
                                #$ -l h_rt=1:00:00 ##wall time.
                                #$ -j y  #concatenates error and output files (with prefix job1)
                                #$ -t 1-2

                                #run job in working directory
                                cd $SGE_O_WORKDIR
                                pwd

                                #Load modules
                                export PATH=/share/apps/java/bin:$PATH
                                export LD_LIBRARY_PATH=/share/apps/java/lib:$LD_LIBRARY_PATH

                                #Define variables
                                BBMERGE=/share/apps/genomics/bbmap-38.59/bbmerge.sh
                                PATH1=/SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_museum_sample/01b_musPERepaired
                                PATH2=/SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_museum_sample/01c_musALL_merged

                                NAME1=$(sed "${SGE_TASK_ID}q;d" R1.museum.names.repaired)
                                NAME2=$(sed "${SGE_TASK_ID}q;d" R2.museum.names.repaired)


                                ##Run BBMerge
                                PREFIX=`echo ${NAME1} | awk -F "_" '{print $1}'`
                                #echo "BBmerge read merging started for $PREFIX" >> bbmerge.log
                                #echo "---------------" >> bbmerge.log

                                echo "time $BBMERGE in1=$PATH1/${NAME1} in2=$PATH1/${NAME2} out=$PATH2/$PREFIX.repaired.merged.fastq.gz outu1=$PATH2/$PREFIX.repaired.unmerged1.fa$
                                time $BBMERGE in1=$PATH1/${NAME1} in2=$PATH1/${NAME2} out=$PATH2/$PREFIX.repaired.merged.fastq.gz outu1=$PATH2/$PREFIX.repaired.unmerged1.fastq.gz$

 
 qsub 01c_bbtools_merge_museum_ARRAY.sh
 #job submitted at 7.48
 
 
 ##18/10/21
 
 ##STEP 2 OF PIPELNE
 
 ###2A: Map to reference genome 
 
 cp -R RefGenome /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP #copied RefGenome from C3_Aricia_agestis to C3_Aricia_agestis_FP
ls 01c_musALL_merged/*repaired.merged*fastq* >> mus.merged.names #Tell Alex about fastq* end star
sed -i s:0c_musALL_merged/::g mus.merged.names #Tell alex about mus.merged.names
mkdir 02a_mapped_museum_MERGED
mkdir 02a_museum_mapped
nano 02a_MapwithBWAmem.ARRAY_museum.merged.sh

            #OUTPUT: 
                    #$ -S /bin/bash
                    #$ -N C3.BWAmem_mod  ##job name
                    #$ -l tmem=16G #RAM
                    #$ -l h_vmem=16G #enforced limit on memory shell usage
                    #$ -l h_rt=15:00:00 ##wall time.
                    #$ -j y  #concatenates error and output files (with prefix job1)
                    #$ -t 1-2

                    #run job in working directory
                    cd $SGE_O_WORKDIR


                    ##Software
                    BWA=/share/apps/genomics/bwa-0.7.17/bwa
                    export PATH=/share/apps/genomics/samtools-1.9/bin:$PATH
                    export LD_LIBRARY_PATH=/share/apps/genomics/samtools-1.9/lib:$LD_LIBRARY_PATH

                    #Define variables
                    SHAREDFOLDER=/SAN/ugi/LepGenomics
                    SPECIES=C3_Aricia_agestis_FP
                    REF=$SHAREDFOLDER/$SPECIES/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna
                    INPUT=$SHAREDFOLDER/$SPECIES/01c_musALL_merged
                    OUTPUT=$SHAREDFOLDER/$SPECIES/02a_mapped_museum_MERGED
                    TAIL="R1.repaired.fastq.gz.repaired.merged.fastq.gz"

                    ##Define ARRAY names
                    NAME=$(sed "${SGE_TASK_ID}q;d" mus.names)


                    ##Run mapping
                    echo "mapping started" >> map.log
                    echo "---------------" >> map.log

                    ##Check if Ref Genome is indexed by bwa
                    if [[ ! $REF.fai ]]
                    then
                            echo $REF" not indexed. Indexing now"
                            $BWA index $REF
                    else
                            echo $REF" indexed"
                    fi


                    ##Map using array

                    sample_name=`echo ${NAME1} | awk -F "." '{print $1}'`    #UNSURE ABOUT "." PART OF SCRIPT
                    echo "[mapping running for] $sample_name"
                    printf "\n"
                    echo "time $BWA mem $REF $INPUT/${NAME}.$TAIL| samtools sort -o  $OUTPUT/${NAME}.MERGED.bam" >> $OUTPUT/map_mus_MERGED.log
                    time $BWA mem $REF $INPUT/${NAME}.$TAIL | samtools sort -o  $OUTPUT/${NAME}.MERGED.bam


qsub 02a_MapwithBWAmem.ARRAY_museum.merged.sh
#JOB SUBMITTED AT 20:35, Started running at 20:39 + 20:43 (for 2 individuals only)




