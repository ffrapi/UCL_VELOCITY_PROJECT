ssh -l fpitsill -J fpitsill@knuckles.cs.ucl.ac.uk pchuckle
#enter password 4/10/21

cd /SAN/ugi/LepGenomics #access shared folder
mkdir C3_Aricia_agestis_FP #created new folder 

#13/10/21

#PRENAME
mkdir scripts
nano prename.pl
/share/apps/perl-5.30.0/bin/perl5.30.0 ../../prename.pl --help
prename.pl
ls prename.pl
nano prename.pl


#COPIED ALL DATA FROM C3_Aricia_agestis TO C3_Aricia_agestis_FP

    #Museum1 (190312)
cp *gz /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_museum
cp *log /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_museum
cp *html /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_museum
            #Example file: AAg-19-1900-02_190312_L005_R1.fastq.gz 

    #Museum2 (191121)
cp *zip /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_museum2 
cp *log /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_museum2
cp *html /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_museum2
            #Example file: AAg-19-1900-04_191121_L003_R1.fastq.gz 

    #Modern1 (L002)
cp *gz /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_modern

    #Modern2_exp (L001)
cp *gz /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_modern_exp


#CONCATENATE MUSEUM SAMPLES

mkdir 00_raw_reads_museum_FINAL/
ls 00_raw_reads_museum/*R1*gz | awk -F "/" '{print $NF}' | awk -F "_" '{print $1}' > museum1.names
ls 00_raw_reads_museum/ALLSAMPLES/*R1*gz | awk -F "/" '{print $NF}' | awk -F "_" '{print $1}' > museumconcat.names
diff museum1.names museumconcat.names | grep 'AAg' | sed 's/^>\ //'> museum1.tomove
wc -l museum1.tomove > count
echo "number of samples to move:" $count
for i in $(cat museum1.tomove); do cp 00_raw_reads_museum/ALLSAMPLES/$i*gz 00_raw_reads_museum_FINAL; done



#14/10/21

#CUTADAPT ON 5 MUSEUM1 SAMPLES

mkdir 00_raw_reads_museum_sample 
cp 01a_museum1_cutadapt_filtering_trimming.sh /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/DATA/00_raw_reads_museum_sample
nano 01a_museum1_cutadapt_filtering_trimming.sh #Changed species name to C3_Aricia_agestis_FP, and Infile/outfile and species number by changing -t from 48 to 5
./01a_museum1_cutadapt_filtering_trimming.sh  #outputs command used to submit job to the cluster
qsub /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01a_filtered_reads_museum_sample/parallel_cutadapt.20211014-125514.smsjob.sh #job submitted to cluster
qstat #to check the status of the job

#CUTADAPT ON 2 MODERN SAMPLES

mkdir 00_raw_reads_modern_exp_sample
cp AAg-19-2016-01_L002_R1.fastq.gz /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_modern_exp_sample
cp AAg-19-2016-02_L002_R1.fastq.gz /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_modern_exp_sample
cp 01a_modern_cutadapt_filtering_trimming.sh /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_modern_exp_sample
nano 01a_modern_cutadapt_filtering_trimming.sh #Changed species name to C3_Aricia_agestis_FP and species number by changing -t from 48 to 5
./01a_modern_cutadapt_filtering_trimming.sh
qsub /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_modern_sample/01a_modern_cutadapt_reads/parallel_cutadapt.20211014-210144.smsjob.sh
qstat

#15/10/21

#CUTADAPT on 2 MODERN SAMPLES RE-ATTEMPT

cp AAg-19-2016-01_L001_R*.fastq.gz /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_modern_sample
mkdir cutadapt_modern_test_output
 nano cutadapt_script_test.sh
 
                ##EDITED FILE
                               SHAREDFOLDER=/SAN/ugi/LepGenomics
                            SCRIPTS=VelocityPipeline/tools
                            SPECIES=C3_Aricia_agestis_FP
                            INFILE=00_raw_reads_modern_sample
                            OUTFILE=00_raw_reads_modern_sample/cutadapt_modern_test_output

                            $SHAREDFOLDER/$SCRIPTS/01a_parallel_cutadapt_UCL.sh \
                            -i $SHAREDFOLDER/$SPECIES/$INFILE \
                            -o $SHAREDFOLDER/$SPECIES/$OUTFILE -t 2 -m 8 -ph 33 \
                            -fwad1 AGATCGGAAGAGCACACGTCTGAACTCCAGTC -rvad1 AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT \
                            -minl 20 -phredq 20;
                            
./cutadapt_script_test.sh 
qsub /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_modern_sample/cutadapt_modern_test_output/parallel_cutadapt.20211015-193411.smsjob.sh
parallel_cutadapt.20211015-193411 - job name/number


#CHECKING JOB STATUS

    #1 Go to output directory specified in the .sh script
    #2 Go to the log file
    #3 The title of the log file gives the name of the job, in the format "jobname".o"jobnumber"."arraynumber", eg parallel_cutadapt.20211015-193411
    #4 move to the home directory using cd and check what log files have written and at what time using ls -ltr *.o*
  

#17/10/21

#Cutadapt sample museum 
cp AAg-19-2016-01_L001_R*.fastq.gz /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_modern_sample
cp AAg-19-1900-03_190312_L005_R*.fastq.gz /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_museum_sample
mkdir 01a_museum_cutadapt_reads
nano 01a_museum1_cutadapt_filtering_trimming.sh 

            #Output: 
                        #!/bin/bash
                        ##################################
                        # Alexandra Jansen van Rensburg
                        # alexjvr@gmail.com
                        # Last modified 06/07/2021 11:22
                        ##################################

                        # Creates submission script to use cutadapt to remove adapters from demultiplexed Illumina libraries.
                        # Poly-A and -T filters have been removed as we decided that these would be dropped due to mapping quality by bwa mem.
                        # Additional filters included in Lymantria monacha dataset
                        # -fwad2 CTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT -fwad3 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
                        # -rvad2 CTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT -rvad3 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

                        SHAREDFOLDER=/SAN/ugi/LepGenomics
                        SCRIPTS=VelocityPipeline/tools
                        SPECIES=C3_Aricia_agestis_FP
                        INFILE=00_raw_reads_museum_sample
                        OUTFILE=00_raw_reads_museum_sample/01a_museum_cutadapt_reads

                        $SHAREDFOLDER/$SCRIPTS/01a_parallel_cutadapt_UCL.sh \
                        -i $SHAREDFOLDER/$SPECIES/$INFILE \
                        -o $SHAREDFOLDER/$SPECIES/$OUTFILE -t 4 -m 8 -ph 33 \
                        -fwad1 AGATCGGAAGAGCACACGTCTGAACTCCAGTC -rvad1 AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGT \
                        -minl 20 -phredq 20;


./01a_museum1_cutadapt_filtering_trimming.sh
qsub /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_museum_sample/01a_museum_cutadapt_reads/parallel_cutadapt.20211017-122826.smsjob.sh
qstat #Started at 12.30 Eqw status after 5-10 minutes

    #Rerun museum cutadapt: 
qsub /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/00_raw_reads_museum_sample/01a_museum_cutadapt_reads/parallel_cutadapt.20211017-130001.smsjob.sh
qstat #Started running at 13:00



                  

##18/10/21

####bbtools for museum (Modified on 21st of October)

/share/apps/genomics/bbmap-38.59/bbmap.sh

ls 01a_museum_cutadapt_reads/*R1*fastq.gz >> R1.museum.names.torepair
ls 01a_museum_cutadapt_reads/*R2*fastq.gz >> R2.museum.names.torepair
sed -i 's:01a_museum_cutadapt_reads/::g' *torepair
mkdir 01b_musPERepaired 

nano 01c_bbtools_repair_museum_ARRAY.sh: 
                                #!/bin/bash
                                #$ -S /bin/bash
                                #$ -N C3.BBRepair  ##job name
                                #$ -l tmem=32G #RAM
                                #$ -l h_vmem=32G #enforced limit on shell memory usage
                                #$ -l h_rt=1:00:00 ##wall time.
                                #$ -j y  #concatenates error and output files (with prefix job1)
                                #$ -t 1-2

                                #run job in working directory
                                cd $SGE_O_WORKDIR
                                pwd

                                #Load modules
                                export PATH=/share/apps/java/bin:$PATH
                                export LD_LIBRARY_PATH=/share/apps/java/lib:$LD_LIBRARY_PATH

                                #Define variables
                                BBREPAIR=/share/apps/genomics/bbmap-38.59/repair.sh
                                SPECIESDIR=/SAN/ugi/LepGenomics/C3_Aricia_agestis_FP
                                PATH1=00_raw_reads_museum_sample/01a_museum_cutadapt_reads
                                PATH2=00_raw_reads_museum_sample/01b_musPERepaired

                                # create input files here by:
                                #ls $SPECIESDIR/$PATH1/*R1* | awk -F "/" '{print $NF}' > R1.museum.names.torepair
                                #ls $SPECIESDIR/$PATH1/*R2* | awk -F "/" '{print $NF}' >  R2.museum.names.torepair


                                NAME1=$(sed "${SGE_TASK_ID}q;d" R1.museum.names.torepair)
                                NAME2=$(sed "${SGE_TASK_ID}q;d" R2.museum.names.torepair)


                                ##Run BBRepair
                                PREFIX=`echo ${NAME2} |awk -F "_" '{print $1}'`
                                echo "$BBREPAIR in=$SPECIESDIR/$PATH1/${NAME1} in2=$SPECIESDIR/$PATH1/${NAME2} out=$SPECIESDIR/$PATH2/${PREFIX}.R1.repaired.fastq.gz out2=$SPECIESDIR/$PATH2/${PREFIX}.R2.repaired.fastq.gz overwrite=f tossbrokenreads " >> repair.log
                                time $BBREPAIR in=$SPECIESDIR/$PATH1/${NAME1} in2=$SPECIESDIR/$PATH1/${NAME2} out=$SPECIESDIR/$PATH2/${PREFIX}.R1.repaired.fastq.gz out2=$SPECIESDIR/$PATH2/${PREFIX}.R2.repaired.fastq.gz overwrite=f tossbrokenreads


#For the script of bbtools, the number of individuals was changed from 1-48 to 1-2 (as this is a sample run), the SPECIESDIR was changed to C3_Aricia_agestis_FP, and PATH1 and PATH2 were changed according to where the 01a_museum_Cutadapt_reads and the new directory 01b_musPERepaired are located.

qsub 01b_bbtools_repair_museum_ARRAY.sh #submitted at 10:47:33, r = 10:50:32, finished = by 10:52
 
 
 
 ####BBtools merge (Modified on 21st of October)
 
 mkdir 01c_musAll_merged
 
 ls 01b_musPERepaired/*R1*gz >> R1.museum.names.repaired
 ls 01b_musPERepaired/*R2*gz >> R2.museum.names.repaired
 sed -i 's:01b_musPERepaired/::g' *repaired
 
 nano 01c_bbtools_merge_museum_ARRAY.sh: 
 
                            #!/bin/bash
                            #$ -S /bin/bash
                            #$ -N E3.BBmerge  ##job name
                            #$ -l tmem=16G #RAM
                            #$ -l h_vmem=16G #enforced limit on shell memory usage
                            #$ -l h_rt=1:00:00 ##wall time.
                            #$ -j y  #concatenates error and output files (with prefix job1)
                            #$ -t 1-2

                            #run job in working directory
                            cd $SGE_O_WORKDIR
                            pwd

                            #Load modules
                            export PATH=/share/apps/java/bin:$PATH
                            export LD_LIBRARY_PATH=/share/apps/java/lib:$LD_LIBRARY_PATH

                            #Define variables
                            BBMERGE=/share/apps/genomics/bbmap-38.59/bbmerge.sh
                            PATH1=/SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01b_musPERepaired
                            PATH2=/SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01c_musALL_merged

                            NAME1=$(sed "${SGE_TASK_ID}q;d" R1.museum.names.repaired)
                            NAME2=$(sed "${SGE_TASK_ID}q;d" R2.museum.names.repaired)


                            ##Run BBMerge
                            PREFIX=`echo ${NAME1} | awk -F "_" '{print $1}'`
                            #echo "BBmerge read merging started for $PREFIX" >> bbmerge.log
                            #echo "---------------" >> bbmerge.log

                            echo "time $BBMERGE in1=$PATH1/${NAME1} in2=$PATH1/${NAME2} out=$PATH2/$PREFIX.repaired.merged.fastq.gz outu1=$PATH2/$PREFIX.repaired.unmerged1.fastq.gz outu2=$PATH2/$PREFIX.repaired.unmerged2.fastq.gz" >> bbmerge.log
                            time $BBMERGE in1=$PATH1/${NAME1} in2=$PATH1/${NAME2} out=$PATH2/$PREFIX.repaired.merged.fastq.gz outu1=$PATH2/$PREFIX.repaired.unmerged1.fastq.gz outu2=$PATH2/$PREFIX.repaired.unmerged2.fastq.gz

 
 qsub 01c_bbtools_merge_museum_ARRAY.sh
 #Job submitted at 11:07:10, Finished = by 11.11

 
 
 ##19/10/21 (MOdified on 21st of October)
 
 ###STEP 2 OF PIPELNE
 
 ###2A: Map to reference genome 

cp -R RefGenome /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP #copied RefGenome from C3_Aricia_agestis to C3_Aricia_agestis_FP

    #Modification: Indexed the reference genome
BWA=/share/apps/genomics/bwa-0.7.17/bwa
$BWA index RefGenome/*fna


ls 01c_musALL_merged/*repaired.merged*fastq* >> mus.merged.names #Tell Alex about fastq* end star
sed -i s:0c_musALL_merged/::g mus.merged.names #Tell alex about mus.merged.names
mkdir 02a_mapped_museum_MERGED
mkdir 02a_museum_mapped
nano 02a_MapwithBWAmem.ARRAY_museum.merged.sh

            #OUTPUT: 
                 #$ -S /bin/bash
                    #$ -N C3.BWAmem_mod  ##job name
                    #$ -l tmem=16G #RAM
                    #$ -l h_vmem=16G #enforced limit on memory shell usage
                    #$ -l h_rt=15:00:00 ##wall time.
                    #$ -j y  #concatenates error and output files (with prefix job1)
                    #$ -t 1-2

                    #run job in working directory
                    cd $SGE_O_WORKDIR


                    ##Software
                    BWA=/share/apps/genomics/bwa-0.7.17/bwa
                    export PATH=/share/apps/genomics/samtools-1.9/bin:$PATH
                    export LD_LIBRARY_PATH=/share/apps/genomics/samtools-1.9/lib:$LD_LIBRARY_PATH

                    #Define variables
                    SHAREDFOLDER=/SAN/ugi/LepGenomics
                    SPECIES=C3_Aricia_agestis_FP
                    REF=$SHAREDFOLDER/$SPECIES/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna
                    INPUT=$SHAREDFOLDER/$SPECIES/01c_musALL_merged
                    OUTPUT=$SHAREDFOLDER/$SPECIES/02a_mapped_museum_MERGED
                    TAIL="R1.repaired.fastq.gz.repaired.merged.fastq.gz"

                    ##Define ARRAY names
                    NAME=$(sed "${SGE_TASK_ID}q;d" mus.names)


                    ##Run mapping
                    echo "mapping started" >> map.log
                    echo "---------------" >> map.log

                    ##Check if Ref Genome is indexed by bwa
                    if [[ ! $REF.fai ]]
                    then
                            echo $REF" not indexed. Indexing now"
                            $BWA index $REF
                    else
                            echo $REF" indexed"
                    fi


                    ##Map using array

                    sample_name=`echo ${NAME1} | awk -F "." '{print $1}'`
                    echo "[mapping running for] $sample_name"
                    printf "\n"
                    echo "time $BWA mem $REF $INPUT/${NAME}.$TAIL| samtools sort -o  $OUTPUT/${NAME}.MERGED.bam" >> $OUTPUT/map_mus_MERGED.log
                    time $BWA mem $REF $INPUT/${NAME}.$TAIL | samtools sort -o  $OUTPUT/${NAME}.MERGED.bam


qsub 02a_MapwithBWAmem.ARRAY_museum.merged.sh #Separator: "."

#TRIALS:
########1JOB SUBMITTED AT 11:18:32, Running = , Finished = Error

time /share/apps/genomics/bwa-0.7.17/bwa mem /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01c_musALL_merged/.R1.repaired.fastq.gz.repaired.merged.fastq.gz| samtools sort -o  /SAN/u$
time /share/apps/genomics/bwa-0.7.17/bwa mem /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01c_musALL_merged/.R1.repaired.fastq.gz.repaired.merged.fastq.gz| samtools sort -o  /SAN/u$
time /share/apps/genomics/bwa-0.7.17/bwa mem /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01c_musALL_merged/.R1.repaired.fastq.gz.repaired.merged.fastq.gz| samtools sort -o  /SAN/u$
time /share/apps/genomics/bwa-0.7.17/bwa mem /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01c_musALL_merged/01c_musALL_merged/AAg-19-1900-01.R1.repaired.fastq.gz.repaired.merged.fa$
time /share/apps/genomics/bwa-0.7.17/bwa mem /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01c_musALL_merged/01c_musALL_merged/AAg-19-1900-03.R1.repaired.fastq.gz.repaired.merged.fa$
time /share/apps/genomics/bwa-0.7.17/bwa mem /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01c_musALL_merged/.R1.repaired.fastq.gz.repaired.merged.fastq.gz| samtools sort -o  /SAN/u$
time /share/apps/genomics/bwa-0.7.17/bwa mem /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01c_musALL_merged/.R1.repaired.fastq.gz.repaired.merged.fastq.gz| samtools sort -o  /SAN/u$
time /share/apps/genomics/bwa-0.7.17/bwa mem /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01c_musALL_merged/.R1.repaired.fastq.gz.repaired.merged.fastq.gz| samtools sort -o  /SAN/u$
time /share/apps/genomics/bwa-0.7.17/bwa mem /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01c_musALL_merged/.R1.repaired.fastq.gz.repaired.merged.fastq.gz| samtools sort -o  /SAN/u$
time /share/apps/genomics/bwa-0.7.17/bwa mem /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01c_musALL_merged/.R1.repaired.fastq.gz.repaired.merged.fastq.gz| samtools sort -o  /SAN/u$
time /share/apps/genomics/bwa-0.7.17/bwa mem /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01c_musALL_merged/.R1.repaired.fastq.gz.repaired.merged.fastq.gz| samtools sort -o  /SAN/u$
time /share/apps/genomics/bwa-0.7.17/bwa mem /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01c_musALL_merged/.R1.repaired.fastq.gz.repaired.merged.fastq.gz| samtools sort -o  /SAN/u$
time /share/apps/genomics/bwa-0.7.17/bwa mem /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01c_musALL_merged/.R1.repaired.fastq.gz.repaired.merged.fastq.gz| samtools sort -o  /SAN/u$


#########2  qsub 02a_MapwithBWAmem.ARRAY_museum.merged.sh #Separator: "." #Removed log file from mappedmuseumMerged Directory
Job submitted 11:32, Finished = 11:42 (queud for some time)
time /share/apps/genomics/bwa-0.7.17/bwa mem /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01c_musALL_merged/.R1.repaired.fastq.gz.repaired.merged.fastq.gz| samtools sort -o  /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/02a_mapped_museum_MERGED/.MERGED.bam
time /share/apps/genomics/bwa-0.7.17/bwa mem /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/01c_musALL_merged/.R1.repaired.fastq.gz.repaired.merged.fastq.gz| samtools sort -o  /SAN/ugi/LepGenomics/C3_Aricia_agestis_FP/02a_mapped_museum_MERGED/.MERGED.bam

#########3 qsub 02a_MapwithBWAmem.ARRAY_museum.merged.sh #Changed mus.names to mus.merged.names Job submitted  11:45:59 
########4 qsub 02a_MapwithBWAmem.ARRAY_museum.merged.sh #Changed mus.merged.names back to mus.names and changed the separator to "_R"

        #After indexing genome: 

            ########5 qsub 02a_MapwithBWAmem.ARRAY_museum.merged.sh #After indexing reference genome, submitted 14:01, finished by 14:04
            #######6 qsub 02a_MapwithBWAmem.ARRAY_museum.merged.sh #After inedxing, changed mus.names to mus.merged.names, submitted at 14.08


##Map ATLAS.sh script

 nano 02a_MapwithBWAmem.ARRAY_museum_forATLA #changed species name, input, output, reference genome etc
 
 #TRIALS: 
 
 #######1qsub 02a_MapwithBWAmem.ARRAY_museum_forATLAS.sh #Started running at 11:36:49 "Separator: "-R", finished by 11:45:59 
 #######2qsub 02a_MapwithBWAmem.ARRAY_museum_forATLAS.sh#Separator: "_R", submitted: 11:48:27  
 
         #after indexing genome: 
         #######3qsub 02a_MapwithBWAmem.ARRAY_museum_forATLAS.sh #Separator "_R" after indexing reference genome, submitted: 14:04:50, finished by 14.08
 
 
 #MAP REFERENCE GENOME WORKED USING THIS SCRIPT: 
 
 qsub 02a_Museum_Mapped.sh
 
 
 
 #23/10/21
 
 ###MAPPING MODC and MODE

###MODC
ls  01a_modern_cutadapt_reads/*R1.fastq* 
ls  01a_modern_cutadapt_reads/*R1.fastq* >> R1.modc.names
ls  01a_modern_cutadapt_reads/*R2.fastq* >> R2.modc.names
sed -i 's:01a_modern_cutadapt_reads/::g' *names
mkdir 02a_modern_mapped
mkdir 02a_modern_mapped/01a_modern_cutadapt_reads

###MODE
ls 01a_modern_exp_cutadapt_reads/*R1.fastq* >> R1.mode.names
ls 01a_modern_exp_cutadapt_reads/*R2.fastq* >> R2.mode.names
 sed -i 's:01a_modern_exp_cutadapt_reads/::g' *names
mkdir 02a_modern_mapped_exp
mkdir 02a_modern_mapped/01a_modern.exp_cutadapt_reads



#SCRIPT:

#!/bin/bash
#$ -S /bin/bash
#$ -N C3.MODC_BWAmem  ##job name
#$ -l tmem=16G #RAM
#$ -l h_vmem=16G #enforced limit on memory shell usage
#$ -l h_rt=10:00:00 ##wall time.
#$ -j y  #concatenates error and output files (with prefix job1)
#$ -t 1-2

#run job in working directory
cd $SGE_O_WORKDIR


##Software
BWA=/share/apps/genomics/bwa-0.7.17/bwa
export PATH=/share/apps/genomics/samtools-1.9/bin:$PATH
export LD_LIBRARY_PATH=/share/apps/genomics/samtools-1.9/lib:$LD_LIBRARY_PATH

#Define variables
SHAREDFOLDER=/SAN/ugi/LepGenomics
SPECIES=C3_Aricia_agestis_FP
REF=$SHAREDFOLDER/$SPECIES/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna
INPUT=$SHAREDFOLDER/$SPECIES/01a_modern_exp_cutadapt_reads
OUTPUT=$SHAREDFOLDER/$SPECIES/02a_modern_mapped_exp

#Create a list of input files
#ls $INPUT/*R1.fastq.gz | awk -F "/" '{print $NF}' > mode.R1.tomap
#ls $INPUT/*R2.fastq.gz | awk -F "/" '{print $NF}' > mode.R2.tomap

#echo "list of samples to map = mode.R1.tomap & mode.R2.tomap" >> map_mode.log

##Define ARRAY names
NAME1=$(sed "${SGE_TASK_ID}q;d" mode.R1.tomap)
NAME2=$(sed "${SGE_TASK_ID}q;d" mode.R2.tomap)


##Map using array

sample_name=`echo ${NAME1} | awk -F "." '{print $1}'`
echo "[mapping running for] $sample_name"
printf "\n"
echo "time $BWA mem $REF $INPUT/${NAME1} $INPUT/${NAME2}| samtools sort -o  $OUTPUT/${NAME1}.forATLAS.bam" >> map_mus.log
time $BWA mem $REF $INPUT/${NAME1} $INPUT/${NAME2} | samtools sort -o  $OUTPUT/${NAME1}.forATLAS.bam


 ##24/10/21
 
 ###DETERMINING FILE SIZE
du -sh *bam   
$samtools view *bam | head
samtools=/share/apps/genomics/samtools-1.9/bin/samtools
$samtools flagstat *bam
for i in $(ls *bam); do ls $i >>flagstat.log && $samtools flagstat $i >> flagstat.log; done
 #Index files script
 
                     nano Index1.sh

                     #!/bin/bash
                    #$ -S /bin/bash
                    #$ -N C3.Mus.Index  ##job name
                    #$ -l tmem=16G #RAM
                    #$ -l h_vmem=16G #enforced limit on shell memory usage
                    #$ -l h_rt=1:00:00 ##wall time.
                    #$ -j y  #concatenates error and output files (with prefix job1)

                    #Script to index a list of bamfiles specified in an input textfile

                    #Run on working directory
                    cd $SGE_O_WORKDIR


                    #Path to software
                    samtools=/share/apps/genomics/samtools-1.9/bin/samtools

                    #Define variables
                    SHAREDFOLDER=/SAN/ugi/LepGenomics
                    SPECIES=C3_Aricia_agestis_FP
                    FOLDER=C3_Subset_Tests
                    REF=$SHAREDFOLDER/$SPECIES/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna
                    INPUT=$SHAREDFOLDER/$SPECIES/$FOLDER/02a_mapped_modern_Downsampled/mus.Downsampled.merged.bamlist
                    OUTPUT=$SHAREDFOLDER/$SPECIES/$FOLDER/02a_mapped_modern_Downsampled
                    TASK=theta


                    #Run analysis
                    while IFS=  read -r line; do $samtools index $line; done < $INPUT

qsub Index1.sh #output was .bai files for each .bam file in the folder

 #25/10/21
 
##PROCESSING BAM FILES
#Changed script for 02b.0, 02b.1, 0.2b.2 and submitted the jobs, resulting log file was created but no output files created.

nano 02b.0_AddRG.sh

                #!/bin/bash
                #$ -S /bin/bash
                #$ -N C3.Mus_AddRG  ##job name
                #$ -l tmem=32G #RAM
                #$ -l h_vmem=32G #enforced limit on shell memory usage
                #$ -l h_rt=1:00:00 ##wall time.
                #$ -j y  #concatenates error and output files (with prefix job1)
                #$ -t 1-2

                #Run on working directory
                cd $SGE_O_WORKDIR

                #Call software
                export PATH=/share/apps/java/bin:$PATH
                export LD_LIBRARY_PATH=/share/apps/java/lib:$LD_LIBRARY_PATH
                PICARD=/share/apps/genomics/picard-2.20.3/bin/picard.jar


                #Define variables
                SHAREDFOLDER=/SAN/ugi/LepGenomics
                SPECIES=C3_Aricia_agestis_FP
                REF=$SHAREDFOLDER/$SPECIES/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna
                INPUT=$SHAREDFOLDER/$SPECIES/02a_mapped_museum_MERGED
                OUTPUT=$SHAREDFOLDER/$SPECIES/02a_mapped_museum_MERGED
                #TAIL=`ls 02a_mapped_museum/*bam | awk -F "/" '{print $NF}' | awk '{print substr($0,14)}' | head -n 1`
                #TAIL=_R1_001.fastq.gzcutadapt_filtered_R1.fastq.gz.forATLAS.bam
                TAIL=.R1.repaired.fastq.gz.repaired.merged.fastq.gz.bam

                #Set up ARRAY job
                #ls 02a_mapped_museum_MERGED/*bam | awk -F "/" '{print $NF}' | awk -F "_" '{print $1}' > mus.names
                NAME=$(sed "${SGE_TASK_ID}q;d" mus.names)


                ##Add readgroups

                echo "java -jar $PICARD AddOrReplaceReadGroups \
                       I=$INPUT/${NAME}$TAIL \
                       O=$OUTPUT/${NAME}.RG.bam \
                       RGID=C3mus \
                       RGLB=mus0204cleancat \
                       RGPL=ILLUMINA \
                       RGPU=unit1 \
                       RGSM=${NAME}" >> 02b.0_AddRG.log


                time java -jar $PICARD AddOrReplaceReadGroups \
                       I=$INPUT/${NAME}$TAIL \
                       O=$OUTPUT/${NAME}.RG.bam \
                       RGID=C3mus \
                       RGLB=mus204cleancat \
                       RGPL=ILLUMINA \
                       RGPU=unit1 \
                       RGSM=${NAME}

 #OUTPUT: nano 02b.1_MarkDup_MODC.sh 
 
                       #!/bin/bash
                    #$ -S /bin/bash
                    #$ -N C3.Mus.MarkDups  ##job name
                    #$ -l tmem=16G #RAM
                    #$ -l h_vmem=16G #enforced limit on shell memory usage
                    #$ -l h_rt=1:00:00 ##wall time.
                    #$ -j y  #concatenates error and output files (with prefix job1)
                    #$ -t 1-2


                    #Run on working directory
                    cd $SGE_O_WORKDIR

                    #Call software
                    export PATH=/share/apps/java/bin:$PATH
                    export LD_LIBRARY_PATH=/share/apps/java/lib:$LD_LIBRARY_PATH
                    PICARD=/share/apps/genomics/picard-2.20.3/bin/picard.jar


                    #Define variables
                    SHAREDFOLDER=/SAN/ugi/LepGenomics
                    SPECIES=C3_Aricia_agestis_FP
                    REF=$SHAREDFOLDER/$SPECIES/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna
                    INPUT=$SHAREDFOLDER/$SPECIES/02a_mapped_museum_MERGED
                    OUTPUT=$SHAREDFOLDER/$SPECIES/02a_mapped_museum_MERGED
                    TAIL="RG.bam"

                    #Set up ARRAY job
                    #ls $INPUT/*RG.bam | awk -F "/" '{print $NF}' | awk -F "." '{print $1}' >> mus.names
                    NAME=$(sed "${SGE_TASK_ID}q;d" mus.names)

                    echo "java -jar $PICARD MarkDuplicates \
                    INPUT=$INPUT/${NAME}.$TAIL \
                    OUTPUT=$OUTPUT/${NAME}.rmdup.bam \
                    METRICS_FILE=$OUTPUT/${NAME}.dup.txt \
                    REMOVE_DUPLICATES=false \
                    VALIDATION_STRINGENCY=SILENT \
                    CREATE_INDEX=true" >> 02b.1_MarkDup.log


                    time java -jar $PICARD MarkDuplicates \
                    INPUT=$INPUT/${NAME}.$TAIL \
                    OUTPUT=$OUTPUT/${NAME}.rmdup.bam \
                    METRICS_FILE=$OUTPUT/${NAME}.dup.txt \
                    REMOVE_DUPLICATES=false \
                    VALIDATION_STRINGENCY=SILENT \
                    CREATE_INDEX=true

#OUTPUT: nano  02b.1_MarkDup_Mus.sh  

                    #!/bin/bash
                    #$ -S /bin/bash
                    #$ -N C3.Mus.MarkDups  ##job name
                    #$ -l tmem=16G #RAM
                    #$ -l h_vmem=16G #enforced limit on shell memory usage
                    #$ -l h_rt=1:00:00 ##wall time.
                    #$ -j y  #concatenates error and output files (with prefix job1)
                    #$ -t 1-2


                    #Run on working directory
                    cd $SGE_O_WORKDIR

                    #Call software
                    export PATH=/share/apps/java/bin:$PATH
                    export LD_LIBRARY_PATH=/share/apps/java/lib:$LD_LIBRARY_PATH
                    PICARD=/share/apps/genomics/picard-2.20.3/bin/picard.jar


                    #Define variables
                    SHAREDFOLDER=/SAN/ugi/LepGenomics
                    SPECIES=C3_Aricia_agestis_FP
                    REF=$SHAREDFOLDER/$SPECIES/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna
                    INPUT=$SHAREDFOLDER/$SPECIES/02a_mapped_museum_MERGED
                    OUTPUT=$SHAREDFOLDER/$SPECIES/02a_mapped_museum_MERGED
                    TAIL="RG.bam"

                    #Set up ARRAY job
                    #ls $INPUT/*RG.bam | awk -F "/" '{print $NF}' | awk -F "." '{print $1}' >> mus.names
                    NAME=$(sed "${SGE_TASK_ID}q;d" mus.names)

                    echo "java -jar $PICARD MarkDuplicates \
                    INPUT=$INPUT/${NAME}.$TAIL \
                    OUTPUT=$OUTPUT/${NAME}.rmdup.bam \
                    METRICS_FILE=$OUTPUT/${NAME}.dup.txt \
                    REMOVE_DUPLICATES=false \
                    VALIDATION_STRINGENCY=SILENT \
                    CREATE_INDEX=true" >> 02b.1_MarkDup.log


                    time java -jar $PICARD MarkDuplicates \
                    INPUT=$INPUT/${NAME}.$TAIL \
                    OUTPUT=$OUTPUT/${NAME}.rmdup.bam \
                    METRICS_FILE=$OUTPUT/${NAME}.dup.txt \
                    REMOVE_DUPLICATES=false \
                    VALIDATION_STRINGENCY=SILENT \
                    CREATE_INDEX=true


#26/10/21

#OUTPUT: nano 02b.2_LocalRealignment_Mus.sh

                        #!/bin/bash
                        #$ -S /bin/bash
                        #$ -N C3.Mus.LocalRealignment  ##job name
                        #$ -l tmem=16G #RAM
                        #$ -l h_vmem=16G #enforced limit on shell memory usage
                        #$ -l h_rt=1:00:00 ##wall time.
                        #$ -j y  #concatenates error and output files (with prefix job1)
                        #$ -t 1-2

                        #Run on working directory
                        cd $SGE_O_WORKDIR

                        #Call software
                        export PATH=/share/apps/jdk1.8.0_131/bin:$PATH
                        export LD_LIBRARY_PATH=/share/apps/jdk1.8.0_131/lib:$LD_LIBRARY_PATH


                        # Define variables
                        SHAREDFOLDER=/SAN/ugi/LepGenomics
                        SPECIES=C3_Aricia_agestis_FP
                        REF=$SHAREDFOLDER/$SPECIES/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna
                        INPUT=$SHAREDFOLDER/$SPECIES/02a_mapped_museum_MERGED
                        OUTPUT=$SHAREDFOLDER/$SPECIES/02a_mapped_museum_MERGED

                        GenomeAnalysisTK=/share/apps/genomics/GenomeAnalysisTK-3.8.1.0/GenomeAnalysisTK.jar


                        #Set up ARRAY job
                        #ls $INPUT/*rmdup.bam |awk -F "/" '{print $NF}' | awk -F "." '{print $1}' > mus.names
                        NAME=$(sed "${SGE_TASK_ID}q;d" mus.names)


                        # Identify targets to realign
                        java -jar $GenomeAnalysisTK -T RealignerTargetCreator \
                        -R $REF \
                        -o $OUTPUT/${NAME}.intervals \
                        -I $INPUT/${NAME}.rmdup.bam


                        # use IndelRealigner to realign the regions found in the RealignerTargetCreator step
                        java -jar $GenomeAnalysisTK -T IndelRealigner \
                        -R $REF \
                        -targetIntervals $INPUT/${NAME}.intervals \
                        -I $INPUT/${NAME}.rmdup.bam \
                        -o $OUTPUT/${NAME}.realn.bam


#ERROR MESSAGE: Reference genome not indexed?


#TRIAL 2: 

                #!/bin/bash
                #$ -S /bin/bash
                #$ -N C3.Mus.LocalRealignment  ##job name
                #$ -l tmem=16G #RAM
                #$ -l h_vmem=16G #enforced limit on shell memory usage
                #$ -l h_rt=1:00:00 ##wall time.  
                #$ -j y  #concatenates error and output files (with prefix job1)
                #$ -t 1-2

                #Run on working directory
                cd $SGE_O_WORKDIR 

                #Call software
                export PATH=/share/apps/jdk1.8.0_131/bin:$PATH
                export LD_LIBRARY_PATH=/share/apps/jdk1.8.0_131/lib:$LD_LIBRARY_PATH


                # Define variables
                SHAREDFOLDER=/SAN/ugi/LepGenomics
                SPECIES=C3_Aricia_agestis_FP
                REF=$SHAREDFOLDER/$SPECIES/RefGenome/GCA_905147365.1_ilAriAges1.1_genomic.fna
                INPUT=$SHAREDFOLDER/$SPECIES/02a_mapped_museum_MERGED
                OUTPUT=$SHAREDFOLDER/$SPECIES/02a_mapped_museum_MERGED

                GenomeAnalysisTK=/share/apps/genomics/GenomeAnalysisTK-3.8.1.0/GenomeAnalysisTK.jar


                #Set up ARRAY job
                #ls $INPUT/*rmdup.bam |awk -F "/" '{print $NF}' | awk -F "." '{print $1}' > mus.names 
                NAME=$(sed "${SGE_TASK_ID}q;d" mus.names)


                # Identify targets to realign
                java -jar $GenomeAnalysisTK -T RealignerTargetCreator \
                -R $REF \
                -o $OUTPUT/${NAME}.intervals \
                -I $INPUT/${NAME}.rmdup.bam


                # use IndelRealigner to realign the regions found in the RealignerTargetCreator step
                java -jar $GenomeAnalysisTK -T IndelRealigner \
                -R $REF \
                -targetIntervals $INPUT/${NAME}.intervals \
                -I $INPUT/${NAME}.rmdup.bam \
                -o $OUTPUT/${NAME}.realn.bam

